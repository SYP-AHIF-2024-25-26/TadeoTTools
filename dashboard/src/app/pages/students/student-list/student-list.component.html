<div class="container mx-auto px-4 py-8 text-text-950">
  <h2 class="my-6 text-2xl font-bold">Student Manager</h2>

  <!-- Filter and actions bar -->
  <div class="mb-4 flex flex-col gap-4">
    <!-- Actions -->
    <div class="flex flex-wrap justify-end gap-2">
      <button
        class="btn btn-primary btn-md whitespace-nowrap text-text-950 dark:text-text-100"
        (click)="clearFilters()"
      >
        Clear Filters
      </button>
      <button
        class="btn btn-primary btn-md whitespace-nowrap text-text-950 dark:text-text-100"
        (click)="approveAllRequested()"
        [disabled]="!hasRequested()"
      >
        Approve All Requested
      </button>
      <button
        class="btn btn-primary btn-md whitespace-nowrap"
        (click)="openAddStudentDialog()"
      >
        Add Student
      </button>
      <button
        class="btn btn-outline btn-md whitespace-nowrap"
        (click)="toggleDataCollapsed()"
        [attr.aria-expanded]="!dataCollapsed()"
      >
        @if (dataCollapsed()) {
          Show Import/Export
        } @else {
          Hide Import/Export
        }
      </button>
    </div>

    @if (!dataCollapsed()) {
      <app-student-import-export (exportFiltered)="exportFusedStudentsCSV()" />
    }

    <!-- Filters and Search -->
    <app-student-filters
      [uniqueDepartments]="uniqueDepartments()"
      [filteredUniqueClasses]="filteredUniqueClasses()"
      [uniqueStops]="uniqueStops()"
      [(departmentFilter)]="departmentFilter"
      [(classFilter)]="classFilter"
      [(stopFilter)]="stopFilter"
      [(statusFilter)]="statusFilter"
      [(searchTerm)]="searchTerm"
    />
  </div>

  <!-- Add Student Modal -->
  @if (showAddStudent()) {
    <app-add-student-dialog
      [uniqueDepartments]="uniqueDepartments()"
      (close)="closeAddStudentDialog()"
      (studentAdded)="refreshStudents()"
    />
  }

  <!-- Desktop Table View (always visible) -->
  <div
    class="table-zebra hidden max-h-[600px] w-full max-w-full overflow-x-auto overflow-y-scroll rounded-box border border-base-content/5 bg-base-100 md:block"
  >
    <table class="table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Class</th>
          <th>Department</th>
          <th>Status</th>
          <th>Assignments</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        @if (filteredStudents().length === 0) {
          <tr>
            <td colspan="6" class="text-center">No students found</td>
          </tr>
        } @else {
          @for (student of filteredStudents(); track student.edufsUsername) {
            <tr>
              <td>{{ student.firstName }} {{ student.lastName }}</td>
              <td>{{ student.studentClass }}</td>
              <td>{{ student.department }}</td>
              <td class="{{ getStudentStatusClass(student) }}">
                {{ getStudentStatusText(student) }}
              </td>
              <td>
                @if (student.studentAssignments.length === 0) {
                  <span class="text-gray-500">--</span>
                } @else if (student.studentAssignments.length === 1) {
                  {{ student.studentAssignments[0].stopName }}
                } @else {
                  <span class="font-semibold text-orange-500">
                    {{ student.studentAssignments.length }} stops
                  </span>
                }
              </td>
              <td>
                @if (student.studentAssignments.length === 0) {
                  <div class="relative">
                    <button
                      class="btn btn-primary btn-sm"
                      #stopsBtn
                      (click)="
                        $event.stopPropagation();
                        openStopsPopup(student, stopsBtn)
                      "
                    >
                      Assign Stop
                    </button>
                  </div>
                } @else if (student.studentAssignments.length === 1) {
                  @if (
                    student.studentAssignments[0].status === Status.Pending
                  ) {
                    <div class="flex gap-1">
                      <button
                        class="btn btn-success btn-sm"
                        (click)="approveSingleAssignment(student)"
                      >
                        Approve
                      </button>
                      <button
                        class="btn btn-error btn-sm"
                        (click)="rejectSingleAssignment(student)"
                      >
                        Reject
                      </button>
                      <button
                        class="btn btn-outline btn-error btn-sm"
                        (click)="deleteAssignment(student, 0)"
                      >
                        Delete
                      </button>
                    </div>
                  } @else {
                    <div class="flex gap-1">
                      <button
                        class="btn btn-primary btn-sm"
                        (click)="undoSingleAssignment(student)"
                      >
                        Undo
                      </button>
                      <button
                        class="btn btn-outline btn-error btn-sm"
                        (click)="deleteAssignment(student, 0)"
                      >
                        Delete
                      </button>
                    </div>
                  }
                } @else {
                  <button
                    class="btn btn-warning btn-sm"
                    (click)="showConflictDetails(student)"
                  >
                    Manage Conflict
                  </button>
                }
              </td>
            </tr>
          }
        }
      </tbody>
    </table>
  </div>

  <!-- Mobile Card View (always visible) -->
  <div class="space-y-4 md:hidden">
    @if (filteredStudents().length === 0) {
      <p class="py-4 text-center">No students found</p>
    } @else {
      @for (student of filteredStudents(); track student.edufsUsername) {
        <div class="rounded-lg bg-white p-4 shadow dark:bg-background-100">
          <div class="flex items-start justify-between">
            <div>
              <p class="text-lg font-bold">
                {{ student.firstName }} {{ student.lastName }}
              </p>
              <p class="text-sm text-text-600 dark:text-text-400">
                {{ student.studentClass }}
              </p>
              <p class="text-sm text-text-600 dark:text-text-400">
                {{ student.department }}
              </p>
            </div>
            <span
              class="text-sm font-semibold px-2 py-1 rounded {{
                getStudentStatusClass(student)
              }}"
            >
              {{ getStudentStatusText(student) }}
            </span>
          </div>
          <div
            class="mt-3 border-t border-background-200 pt-3 dark:border-background-700"
          >
            <p class="text-sm">
              <span class="text-text-600 dark:text-text-400">Assignments:</span>
              @if (student.studentAssignments.length === 0) {
                --
              } @else if (student.studentAssignments.length === 1) {
                {{ student.studentAssignments[0].stopName }}
              } @else {
                <span class="font-semibold text-orange-500"
                  >{{ student.studentAssignments.length }} stops</span
                >
              }
            </p>
          </div>
          <div class="mt-3 flex flex-wrap gap-2">
            @if (student.studentAssignments.length === 0) {
              <button
                class="btn btn-primary btn-sm flex-grow"
                #stopsBtn
                (click)="
                  $event.stopPropagation(); openStopsPopup(student, stopsBtn)
                "
              >
                Assign Stop
              </button>
            } @else if (student.studentAssignments.length === 1) {
              @if (student.studentAssignments[0].status === Status.Pending) {
                <button
                  class="btn btn-success btn-sm flex-grow"
                  (click)="approveSingleAssignment(student)"
                >
                  Approve
                </button>
                <button
                  class="btn btn-error btn-sm flex-grow"
                  (click)="rejectSingleAssignment(student)"
                >
                  Reject
                </button>
              } @else {
                <button
                  class="btn btn-primary btn-sm flex-grow"
                  (click)="undoSingleAssignment(student)"
                >
                  Undo
                </button>
              }
              <button
                class="btn btn-outline btn-error btn-sm flex-grow"
                (click)="deleteAssignment(student, 0)"
              >
                Delete
              </button>
            } @else {
              <button
                class="btn btn-warning btn-sm flex-grow"
                (click)="showConflictDetails(student)"
              >
                Manage Conflict
              </button>
            }
          </div>
        </div>
      }
    }
  </div>

  <!-- Conflict Details Modal -->
  @if (selectedStudent()) {
    <app-conflict-details-modal
      [student]="selectedStudent()!"
      (close)="closeConflictDetails()"
      (refresh)="refreshStudents()"
    />
  }
</div>
