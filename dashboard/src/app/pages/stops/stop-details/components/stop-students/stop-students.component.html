<div class="mb-4">
  <div
    class="mb-2 flex cursor-pointer items-center justify-between rounded-lg bg-primary-200 p-2 pl-5"
    (click)="toggle()"
  >
    <h1 class="text-lg font-medium text-text-950">Students</h1>
    <span class="text-text-900">{{ isExpanded() ? '▼' : '►' }}</span>
  </div>
  <div [ngClass]="{ hidden: !isExpanded() }">
    <div class="mt-4 flex flex-col gap-4 md:flex-row">
      <!-- Selected Students (Left Side) -->
      <div class="w-full md:w-1/2">
        <div class="mb-2 text-sm font-medium text-text-950">
          Assigned Students
        </div>
        <!-- Assigned Students Filter -->
        <div class="mb-4">
          <div
            class="mb-2 flex flex-col items-start gap-4 sm:flex-row sm:items-center sm:justify-between"
          >
            <div class="flex w-full items-center sm:w-auto">
              <label
                for="assignedClassFilter"
                class="mr-2 flex-shrink-0 text-sm font-medium text-text-950"
                >Class:</label
              >
              <select
                id="assignedClassFilter"
                (change)="onAssignedClassSelect($event)"
                class="w-full rounded-lg border border-primary-200 bg-background-50 p-1.5 text-sm text-text-950 focus:border-primary-300 focus:ring-primary-300 sm:w-auto"
              >
                @for (className of availableClasses(); track className) {
                  <option
                    [value]="className"
                    [selected]="selectedAssignedClass() === className"
                  >
                    {{ className === 'all' ? 'All Classes' : className }}
                  </option>
                }
              </select>
            </div>
            <div class="flex w-full items-center sm:w-auto">
              <label
                for="assignedStudentFilter"
                class="mr-2 flex-shrink-0 text-sm font-medium text-text-950"
                >Search:</label
              >
              <input
                id="assignedStudentFilter"
                type="text"
                [ngModel]="assignedStudentFilterText()"
                (ngModelChange)="assignedStudentFilterText.set($event)"
                placeholder="Name or username"
                class="w-full rounded-lg border border-primary-200 bg-background-50 p-1.5 text-sm text-text-950 focus:border-primary-300 focus:ring-primary-300 sm:w-auto"
                name="assignedStudentFilter"
              />
            </div>
          </div>
        </div>
        <div
          class="h-56 w-full overflow-y-auto rounded-lg border border-primary-200 bg-background-50"
        >
          <ul class="divide-y divide-primary-100">
            @for (
              student of filteredAssignedStudents();
              track student.edufsUsername
            ) {
              <li
                class="flex items-center justify-between px-4 py-2 text-sm text-text-950 hover:bg-primary-100"
              >
                <div>
                  {{ student.lastName + ' ' + student.firstName }}
                  <span class="ml-2 text-xs text-text-900"
                    >({{ student.studentClass }})</span
                  >
                </div>
                <div class="flex items-center">
                  <span
                    class="mr-2 rounded-full px-2 py-0.5 text-xs font-medium"
                    [ngClass]="getStatusClass(getAssignmentStatus(student))"
                  >
                    {{ getStatusLabel(getAssignmentStatus(student)) }}
                  </span>
                  <span
                    class="cursor-pointer text-lg font-bold text-accent-600"
                    (click)="removeStudent(student.edufsUsername)"
                    >−</span
                  >
                </div>
              </li>
            }
            @if (filteredAssignedStudents().length === 0) {
              <li class="px-4 py-2 text-sm text-text-900">
                No students assigned
              </li>
            }
          </ul>
        </div>
      </div>

      <!-- Available Students (Right Side) -->
      <div class="w-full md:w-1/2">
        <div class="mb-2 text-sm font-medium text-text-950">
          Available Students (no accepted assignments)
        </div>
        <!-- Available Students Filter -->
        <div class="mb-4">
          <div
            class="mb-2 flex flex-col items-start gap-4 sm:flex-row sm:items-center sm:justify-between"
          >
            <div class="flex w-full items-center sm:w-auto">
              <label
                for="availableClassFilter"
                class="mr-2 flex-shrink-0 text-sm font-medium text-text-950"
                >Class:</label
              >
              <select
                id="availableClassFilter"
                (change)="onAvailableClassSelect($event)"
                class="w-full rounded-lg border border-primary-200 bg-background-50 p-1.5 text-sm text-text-950 focus:border-primary-300 focus:ring-primary-300 sm:w-auto"
              >
                @for (className of availableClasses(); track className) {
                  <option
                    [value]="className"
                    [selected]="selectedAvailableClass() === className"
                  >
                    {{ className === 'all' ? 'All Classes' : className }}
                  </option>
                }
              </select>
            </div>
            <div class="flex w-full items-center sm:w-auto">
              <label
                for="availableStudentFilter"
                class="mr-2 flex-shrink-0 text-sm font-medium text-text-950"
                >Search:</label
              >
              <input
                id="availableStudentFilter"
                type="text"
                [ngModel]="availableStudentFilterText()"
                (ngModelChange)="availableStudentFilterText.set($event)"
                placeholder="Name or username"
                class="w-full rounded-lg border border-primary-200 bg-background-50 p-1.5 text-sm text-text-950 focus:border-primary-300 focus:ring-primary-300 sm:w-auto"
                name="availableStudentFilter"
              />
            </div>
          </div>
        </div>
        <div
          class="h-56 w-full overflow-y-auto rounded-lg border border-primary-200 bg-background-50"
        >
          <ul class="divide-y divide-primary-100">
            @for (student of studentsNotInStop(); track student.edufsUsername) {
              <li
                class="flex items-center justify-between px-4 py-2 text-sm text-text-950 hover:bg-primary-100"
              >
                <div>
                  {{ student.lastName + ' ' + student.firstName }}
                  <span class="ml-2 text-xs text-text-900"
                    >({{ student.studentClass }})</span
                  >
                  @if (hasOtherAssignments(student.edufsUsername)) {
                    <span class="ml-2 text-sm font-medium text-amber-700">
                      ({{
                        getStudentOtherAssignmentsCount(student.edufsUsername)
                      }}
                      Request{{
                        getStudentOtherAssignmentsCount(student.edufsUsername) >
                        1
                          ? 's'
                          : ''
                      }})
                    </span>
                  }
                </div>
                <div class="flex items-center">
                  <span
                    class="cursor-pointer text-lg font-bold text-primary-600"
                    (click)="onStudentClick(student.edufsUsername)"
                    >+</span
                  >
                </div>
              </li>
            }
            @if (studentsNotInStop().length === 0) {
              <li class="px-4 py-2 text-sm text-text-900">
                No more students available
              </li>
            }
          </ul>
        </div>
      </div>
    </div>
  </div>
  <button
    (click)="downloadStudentsOfStopData()"
    type="button"
    class="btn btn-primary btn-sm mt-4 gap-2 self-start"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="mr-1 h-5 w-5"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
      />
    </svg>
    Download Students of Stop
  </button>
</div>
