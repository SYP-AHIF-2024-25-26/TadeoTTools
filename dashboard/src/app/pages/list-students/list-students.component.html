<div class="container mx-auto px-4 py-8 text-text-950">
  <h2 class="my-6 text-2xl font-bold">Student Manager</h2>

  <!-- Filter and actions bar -->
  <div class="mb-4 flex flex-col gap-4">
    <!-- Actions -->
    <div class="flex flex-wrap justify-end gap-2">
      <button
        class="btn btn-primary btn-md whitespace-nowrap text-text-950 dark:text-text-100"
        (click)="clearFilters()"
      >
        Clear Filters
      </button>
      <button
        class="btn btn-primary btn-md whitespace-nowrap text-text-950 dark:text-text-100"
        (click)="approveAllRequested()"
        [disabled]="!hasRequested()"
      >
        Approve All Requested
      </button>
      <button
        class="btn btn-primary btn-md whitespace-nowrap"
        (click)="openAddStudentDialog()"
      >
        Add Student
      </button>
      <button
        class="btn btn-outline btn-md whitespace-nowrap"
        (click)="toggleDataCollapsed()"
        [attr.aria-expanded]="!dataCollapsed()"
      >
        @if (dataCollapsed()) {
          Show Import/Export
        } @else {
          Hide Import/Export
        }
      </button>
    </div>
    @if (!dataCollapsed()) {
      <div>
        <div
          class="mb-4 flex flex-col gap-4 md:flex-row md:items-start md:justify-between"
        >
          <!-- Left: Import -->
          <div class="flex-1">
            <fieldset class="fieldset">
              <legend class="fieldset-legend text-lg">
                Import Students Csv
              </legend>
              <div class="flex flex-col gap-4 sm:flex-row">
                <input
                  type="file"
                  class="file-input file-input-primary file-input-sm w-full"
                  accept=".csv"
                  (change)="onStudentFileSelected($event)"
                />
                <button
                  class="btn btn-primary btn-sm self-center px-4 sm:self-end"
                  (click)="submitStudentsCsv()"
                  [disabled]="!selectedStudentFile"
                >
                  Import
                </button>
              </div>
            </fieldset>
            <div
              class="my-2 hidden rounded-lg bg-background-100 p-2 dark:border dark:border-accent-400 md:block"
            >
              <p class="font-mono text-sm text-text-600">
                EdufsUsername;FirstName;LastName;StudentClass;Department
              </p>
            </div>
          </div>

          <!-- Right: Export/Download -->
          <div class="gap-2 md:flex md:flex-col md:items-end md:justify-start">
            <fieldset class="fieldset">
              <legend class="fieldset-legend text-lg">Export Students</legend>
              <div class="flex flex-col gap-2">
                <button
                  (click)="downloadStudentsData()"
                  class="btn btn-primary btn-sm w-full md:w-auto"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="mr-1 h-5 w-5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                    />
                  </svg>
                  Download Students with Assignments
                </button>
                <button
                  class="btn btn-primary btn-sm w-full md:w-auto"
                  (click)="exportFusedStudentsCSV()"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="mr-1 h-5 w-5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                    />
                  </svg>
                  Download Students
                </button>
              </div>
            </fieldset>
          </div>
        </div>
      </div>
    }

    <!-- Filters and Search -->
    <div class="flex flex-col gap-4 md:flex-row md:items-end">
      <div
        class="grid flex-1 grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5"
      >
        <div class="form-control">
          <label class="label">
            <span class="label-text">Department</span>
          </label>
          <select
            class="select select-bordered w-full bg-primary-300 hover:bg-primary-400"
            [(ngModel)]="departmentFilter"
          >
            <option value="">All Departments</option>
            @for (dep of uniqueDepartments(); track dep) {
              <option [value]="dep">{{ dep }}</option>
            }
          </select>
        </div>

        <div class="form-control">
          <label class="label">
            <span class="label-text">Class Filter</span>
          </label>
          <select
            class="select select-bordered w-full bg-primary-300 hover:bg-primary-400"
            [(ngModel)]="classFilter"
          >
            <option value="">All Classes</option>
            @for (className of filteredUniqueClasses(); track className) {
              <option [value]="className">{{ className }}</option>
            }
          </select>
        </div>

        <div class="form-control">
          <label class="label">
            <span class="label-text">Stop Filter</span>
          </label>
          <select
            class="select select-bordered w-full bg-primary-300 hover:bg-primary-400"
            [(ngModel)]="stopFilter"
          >
            <option value="">All Stops</option>
            @for (stopName of uniqueStops(); track stopName) {
              <option [value]="stopName">{{ stopName }}</option>
            }
          </select>
        </div>

        <div class="form-control">
          <label class="label">
            <span class="label-text">Status</span>
          </label>
          <select
            class="select select-bordered w-full bg-primary-300 hover:bg-primary-400"
            [(ngModel)]="statusFilter"
          >
            <option value="all">All</option>
            <option value="unassigned">Unassigned</option>
            <option value="conflict">Conflicts</option>
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
          </select>
        </div>

        <div class="form-control">
          <label class="label">
            <span class="label-text">Search</span>
          </label>
          <input
            type="text"
            placeholder="Search by (user)name"
            class="input input-bordered h-12 w-full"
            [(ngModel)]="searchTerm"
          />
        </div>
      </div>
    </div>
  </div>

  <!-- Add Student Modal -->
  @if (showAddStudent()) {
    <div
      class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
    >
      <div
        class="w-full max-w-xl rounded-lg bg-white p-6 shadow-lg dark:bg-background-800"
      >
        <div class="mb-4 flex items-center justify-between">
          <h3 class="text-xl font-bold">Add Student</h3>
          <button
            class="btn btn-circle btn-sm"
            (click)="closeAddStudentDialog()"
          >
            ✕
          </button>
        </div>

        @if (addStudentError()) {
          <div class="alert alert-error mb-4" role="alert">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6 shrink-0 stroke-current"
              fill="none"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M12 8v.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
            <span>{{ addStudentError() }}</span>
          </div>
        }

        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div class="form-control md:col-span-2">
            <label class="label"
              ><span class="label-text">EduFS Username</span></label
            >
            <input
              class="input input-bordered"
              [(ngModel)]="newStudent.edufsUsername"
              placeholder="e.g. if123456"
            />
          </div>
          <div class="form-control">
            <label class="label"
              ><span class="label-text">First Name</span></label
            >
            <input
              class="input input-bordered"
              [(ngModel)]="newStudent.firstName"
              placeholder="First name"
            />
          </div>
          <div class="form-control">
            <label class="label"
              ><span class="label-text">Last Name</span></label
            >
            <input
              class="input input-bordered"
              [(ngModel)]="newStudent.lastName"
              placeholder="Last name"
            />
          </div>
          <div class="form-control">
            <label class="label"><span class="label-text">Class</span></label>
            <input
              class="input input-bordered"
              [(ngModel)]="newStudent.studentClass"
              placeholder="e.g. 5AHIF"
            />
          </div>
          <div class="form-control">
            <label class="label"
              ><span class="label-text">Department</span></label
            >
            <select
              class="select select-bordered w-full bg-primary-300 hover:bg-primary-400"
              [(ngModel)]="newStudent.department"
            >
              <option value="">Select department</option>
              @for (dep of uniqueDepartments(); track dep) {
                <option [value]="dep">{{ dep }}</option>
              }
            </select>
          </div>
        </div>

        <div class="mt-6 flex justify-end gap-2">
          <button class="btn btn-ghost" (click)="closeAddStudentDialog()">
            Cancel
          </button>
          <button
            class="btn btn-primary"
            (click)="saveNewStudent()"
            [disabled]="
              !newStudent.edufsUsername ||
              !newStudent.firstName ||
              !newStudent.lastName ||
              !newStudent.studentClass ||
              !newStudent.department
            "
          >
            Save
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Desktop Table View (always visible) -->
  <div
    class="table-zebra hidden max-h-[600px] w-full max-w-full overflow-x-auto overflow-y-scroll rounded-box border border-base-content/5 bg-base-100 md:block"
  >
    <table class="table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Class</th>
          <th>Department</th>
          <th>Status</th>
          <th>Assignments</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        @if (filteredStudents().length === 0) {
          <tr>
            <td colspan="6" class="text-center">No students found</td>
          </tr>
        } @else {
          @for (student of filteredStudents(); track student.edufsUsername) {
            <tr>
              <td>{{ student.firstName }} {{ student.lastName }}</td>
              <td>{{ student.studentClass }}</td>
              <td>{{ student.department }}</td>
              <td class="{{ getStudentStatusClass(student) }}">
                {{ getStudentStatusText(student) }}
              </td>
              <td>
                @if (student.studentAssignments.length === 0) {
                  <span class="text-gray-500">--</span>
                } @else if (student.studentAssignments.length === 1) {
                  {{ student.studentAssignments[0].stopName }}
                } @else {
                  <span class="font-semibold text-orange-500">
                    {{ student.studentAssignments.length }} stops
                  </span>
                }
              </td>
              <td>
                @if (student.studentAssignments.length === 0) {
                  <div class="relative">
                    <button
                      class="btn btn-primary btn-sm"
                      #stopsBtn
                      (click)="
                        $event.stopPropagation();
                        openStopsPopup(student, stopsBtn)
                      "
                    >
                      Assign Stop
                    </button>
                  </div>
                } @else if (student.studentAssignments.length === 1) {
                  @if (
                    student.studentAssignments[0].status === Status.Pending
                  ) {
                    <div class="flex gap-1">
                      <button
                        class="btn btn-success btn-sm"
                        (click)="approveSingleAssignment(student)"
                      >
                        Approve
                      </button>
                      <button
                        class="btn btn-error btn-sm"
                        (click)="rejectSingleAssignment(student)"
                      >
                        Reject
                      </button>
                      <button
                        class="btn btn-outline btn-error btn-sm"
                        (click)="deleteAssignment(student, 0)"
                      >
                        Delete
                      </button>
                    </div>
                  } @else {
                    <div class="flex gap-1">
                      <button
                        class="btn btn-primary btn-sm"
                        (click)="undoSingleAssignment(student)"
                      >
                        Undo
                      </button>
                      <button
                        class="btn btn-outline btn-error btn-sm"
                        (click)="deleteAssignment(student, 0)"
                      >
                        Delete
                      </button>
                    </div>
                  }
                } @else {
                  <button
                    class="btn btn-warning btn-sm"
                    (click)="showConflictDetails(student)"
                  >
                    Manage Conflict
                  </button>
                }
              </td>
            </tr>
          }
        }
      </tbody>
    </table>
  </div>

  <!-- Mobile Card View (always visible) -->
  <div class="space-y-4 md:hidden">
    @if (filteredStudents().length === 0) {
      <p class="py-4 text-center">No students found</p>
    } @else {
      @for (student of filteredStudents(); track student.edufsUsername) {
        <div class="rounded-lg bg-white p-4 shadow dark:bg-background-100">
          <div class="flex items-start justify-between">
            <div>
              <p class="text-lg font-bold">
                {{ student.firstName }} {{ student.lastName }}
              </p>
              <p class="text-sm text-text-600 dark:text-text-400">
                {{ student.studentClass }}
              </p>
              <p class="text-sm text-text-600 dark:text-text-400">
                {{ student.department }}
              </p>
            </div>
            <span
              class="text-sm font-semibold px-2 py-1 rounded {{
                getStudentStatusClass(student)
              }}"
            >
              {{ getStudentStatusText(student) }}
            </span>
          </div>
          <div
            class="mt-3 border-t border-background-200 pt-3 dark:border-background-700"
          >
            <p class="text-sm">
              <span class="text-text-600 dark:text-text-400">Assignments:</span>
              @if (student.studentAssignments.length === 0) {
                --
              } @else if (student.studentAssignments.length === 1) {
                {{ student.studentAssignments[0].stopName }}
              } @else {
                <span class="font-semibold text-orange-500"
                  >{{ student.studentAssignments.length }} stops</span
                >
              }
            </p>
          </div>
          <div class="mt-3 flex flex-wrap gap-2">
            @if (student.studentAssignments.length === 0) {
              <button
                class="btn btn-primary btn-sm flex-grow"
                #stopsBtn
                (click)="
                  $event.stopPropagation(); openStopsPopup(student, stopsBtn)
                "
              >
                Assign Stop
              </button>
            } @else if (student.studentAssignments.length === 1) {
              @if (student.studentAssignments[0].status === Status.Pending) {
                <button
                  class="btn btn-success btn-sm flex-grow"
                  (click)="approveSingleAssignment(student)"
                >
                  Approve
                </button>
                <button
                  class="btn btn-error btn-sm flex-grow"
                  (click)="rejectSingleAssignment(student)"
                >
                  Reject
                </button>
              } @else {
                <button
                  class="btn btn-primary btn-sm flex-grow"
                  (click)="undoSingleAssignment(student)"
                >
                  Undo
                </button>
              }
              <button
                class="btn btn-outline btn-error btn-sm flex-grow"
                (click)="deleteAssignment(student, 0)"
              >
                Delete
              </button>
            } @else {
              <button
                class="btn btn-warning btn-sm flex-grow"
                (click)="showConflictDetails(student)"
              >
                Manage Conflict
              </button>
            }
          </div>
        </div>
      }
    }
  </div>

  <!-- Conflict Details Modal -->
  @if (selectedStudent()) {
    <div
      class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
    >
      <div
        class="max-h-[80vh] w-full max-w-3xl overflow-y-auto rounded-lg bg-white p-6 shadow-lg dark:bg-background-800"
      >
        <div class="mb-4 flex items-center justify-between">
          <h3 class="text-xl font-bold">
            Request Details for {{ selectedStudent()!.firstName }}
            {{ selectedStudent()!.lastName }}
          </h3>
          <button
            class="btn btn-circle btn-sm"
            (click)="closeConflictDetails()"
          >
            ✕
          </button>
        </div>

        <div class="hidden overflow-x-auto md:block">
          <table class="table table-zebra w-full">
            <thead>
              <tr>
                <th>Stop Name</th>
                <th>Status</th>
                <th>Action</th>
                <th>Delete</th>
              </tr>
            </thead>
            <tbody>
              @for (
                assignment of selectedStudent()!.studentAssignments;
                track $index
              ) {
                <tr>
                  <td>{{ assignment.stopName }}</td>
                  <td class="{{ getStatusClass(assignment.status) }}">
                    {{ getStatusText(assignment.status) }}
                  </td>
                  <td class="flex gap-2">
                    @if (assignment.status === Status.Pending) {
                      <button
                        class="btn btn-success btn-sm"
                        (click)="approveAssignment(selectedStudent()!, $index)"
                      >
                        Accept
                      </button>
                      <button
                        class="btn btn-error btn-sm"
                        (click)="rejectAssignment(selectedStudent()!, $index)"
                      >
                        Reject
                      </button>
                    } @else {
                      <button
                        class="btn btn-primary btn-sm"
                        (click)="undoAssignment(selectedStudent()!, $index)"
                      >
                        Undo
                      </button>
                    }
                  </td>
                  <td>
                    <button
                      class="btn btn-error btn-sm"
                      (click)="deleteAssignment(selectedStudent()!, $index)"
                    >
                      Delete
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Mobile Card View -->
        <div class="space-y-4 md:hidden">
          @for (
            assignment of selectedStudent()!.studentAssignments;
            track $index
          ) {
            <div
              class="rounded-lg bg-background-100 p-4 shadow dark:bg-background-900"
            >
              <div class="flex items-start justify-between">
                <p class="font-bold">{{ assignment.stopName }}</p>
                <span
                  class="text-sm font-semibold px-2 py-1 rounded {{
                    getStatusClass(assignment.status)
                  }}"
                >
                  {{ getStatusText(assignment.status) }}
                </span>
              </div>
              <div
                class="mt-4 flex flex-wrap gap-2 border-t border-background-200 pt-4 dark:border-background-700"
              >
                @if (assignment.status === Status.Pending) {
                  <button
                    class="btn btn-success btn-sm flex-1"
                    (click)="approveAssignment(selectedStudent()!, $index)"
                  >
                    Accept
                  </button>
                  <button
                    class="btn btn-error btn-sm flex-1"
                    (click)="rejectAssignment(selectedStudent()!, $index)"
                  >
                    Reject
                  </button>
                } @else {
                  <button
                    class="btn btn-primary btn-sm flex-1"
                    (click)="undoAssignment(selectedStudent()!, $index)"
                  >
                    Undo
                  </button>
                }
                <button
                  class="btn btn-outline btn-error btn-sm"
                  (click)="deleteAssignment(selectedStudent()!, $index)"
                >
                  Delete
                </button>
              </div>
            </div>
          }
        </div>
      </div>
    </div>
  }
</div>
